local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "HM HUB",
    LoadingTitle = "Loading HM HUB",
    LoadingSubtitle = "by The Hollows",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = nil,           -- nil = default folder
        FileName = "HM Hub"
    },
    KeySystem = false
})
task.wait(0.2)
local MainTab = Window:CreateTab("Player", 7072718362) 

-- Dropdown: Shows Humanoid.DisplayName (fallback to model name) from workspace.Worlds.Targets.Server

local function getServerMobs()
    local options = {"None / No Mobs Found"}
    
    local serverFolder = workspace
        :FindFirstChild("Worlds")
        and workspace.Worlds:FindFirstChild("Targets")
        and workspace.Worlds.Targets:FindFirstChild("Server")
    
    if not serverFolder then
        return options
    end
    
    local seen = {}
    
    -- Scan direct children (most common for mob models)
    for _, child in ipairs(serverFolder:GetChildren()) do
        if child:IsA("Model") then
            local humanoid = child:FindFirstChildOfClass("Humanoid")
            local displayName = humanoid and humanoid.DisplayName or nil
            
            local nameToShow = (displayName and displayName ~= "") and displayName or child.Name
            
            if nameToShow and nameToShow ~= "" and not seen[nameToShow] then
                seen[nameToShow] = true
                table.insert(options, nameToShow)
            end
        end
    end
    
    -- Also scan deeper if mobs are nested
    for _, descendant in ipairs(serverFolder:GetDescendants()) do
        if descendant:IsA("Model") then
            local humanoid = descendant:FindFirstChildOfClass("Humanoid")
            local displayName = humanoid and humanoid.DisplayName or nil
            
            local nameToShow = (displayName and displayName ~= "") and displayName or descendant.Name
            
            if nameToShow and nameToShow ~= "" and not seen[nameToShow] then
                seen[nameToShow] = true
                table.insert(options, nameToShow)
            end
        end
    end
    
    table.sort(options)
    return options
end

-- Dropdown
local selectedMob = "None / No Mobs Found"

local MobDropdown = MainTab:CreateDropdown({
    Name = "Server Mobs (workspace.Worlds.Targets.Server)",
    Options = getServerMobs(),
    CurrentOption = {"None / No Mobs Found"},
    MultipleOptions = false,
    Flag = "ServerMobList",
    Callback = function(option)
        selectedMob = option[1]
        Rayfield:Notify({
            Title = "Mob Selected",
            Content = "Now selected: " .. selectedMob,
            Duration = 4
        })
        print("Selected mob:", selectedMob)
    end,
})

-- Manual refresh button
MainTab:CreateButton({
    Name = "ðŸ”„ Refresh Mob List",
    Callback = function()
        local newOptions = getServerMobs()
        MobDropdown:Refresh(newOptions, true)  -- true = reset to first option
        
        Rayfield:Notify({
            Title = "Mob List Updated",
            Content = "Found " .. (#newOptions - 1) .. " mobs",
            Duration = 4
        })
    end,
})

-- Auto-refresh when folder changes (added/removed mobs)
local serverFolder = workspace
    :WaitForChild("Worlds", 10)
    :WaitForChild("Targets", 10)
    :WaitForChild("Server", 10)

if serverFolder then
    serverFolder.ChildAdded:Connect(function()
        task.delay(0.5, function()
            local newOpts = getServerMobs()
            MobDropdown:Refresh(newOpts, false)  -- false = keep current selection if possible
        end)
    end)
    
    serverFolder.ChildRemoved:Connect(function()
        task.delay(0.5, function()
            local newOpts = getServerMobs()
            MobDropdown:Refresh(newOpts, false)
        end)
    end)
    
    print("[Mob Dropdown] Auto-refresh enabled on workspace.Worlds.Targets.Server")
else
    warn("[Mob Dropdown] Could not find workspace.Worlds.Targets.Server - auto-refresh disabled")
end

-- Initial scan
task.delay(1, function()
    local initial = getServerMobs()
    MobDropdown:Refresh(initial, true)
end)

-- Auto Send Pets on Current Target Death + Auto Switch to Next Closest

local autoSendPetsEnabled = false
local currentAttackedMob = nil   -- the mob we are currently attacking
local trackedHealth = {}         -- [mob] = last known health

-- Helper: Find closest mob of selected type
local function findClosestMobOfType()
    local serverFolder = workspace
        :FindFirstChild("Worlds")
        :FindFirstChild("Targets")
        :FindFirstChild("Server")
    
    if not serverFolder then return nil end
    
    local playerChar = player.Character
    local hrp = playerChar and playerChar:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    
    local closest = nil
    local minDist = math.huge
    
    for _, obj in ipairs(serverFolder:GetDescendants()) do
        if obj:IsA("Model") then
            local humanoid = obj:FindFirstChildOfClass("Humanoid")
            local root = obj:FindFirstChild("HumanoidRootPart") or obj.PrimaryPart
            
            if humanoid and root and humanoid.Health > 0 then
                local mobType = obj:GetAttribute("Name") or obj.Name
                if mobType == selectedMobType then
                    local dist = (hrp.Position - root.Position).Magnitude
                    if dist < minDist then
                        minDist = dist
                        closest = {
                            obj = obj,
                            root = root,
                            dist = dist,
                            humanoid = humanoid
                        }
                    end
                end
            end
        end
    end
    
    return closest
end

MiscTab:CreateToggle({
    Name = "Auto Send Pets",
    CurrentValue = false,
    Flag = "AutoPetsOnDeathSwitch",
    Callback = function(enabled)
        autoSendPetsEnabled = enabled
        
        if enabled then
            Rayfield:Notify({
                Title = "Auto Pets Activated",
                Content = "Sending pets on death & switching to next closest " .. selectedMobType,
                Duration = 5
            })
            
            trackedHealth = {}           -- reset tracking
            currentAttackedMob = nil     -- reset target
            
            task.spawn(function()
                while autoSendPetsEnabled do
                    task.wait(0.35)  -- check every ~0.35s
                    
                    local playerChar = player.Character
                    local hrp = playerChar and playerChar:FindFirstChild("HumanoidRootPart")
                    if not hrp then continue end
                    
                    -- If no current target â†’ find the closest one
                    if not currentAttackedMob or not currentAttackedMob.obj or currentAttackedMob.humanoid.Health <= 0 then
                        local nextMob = findClosestMobOfType()
                        if nextMob then
                            currentAttackedMob = nextMob
                            trackedHealth[nextMob.obj] = nextMob.humanoid.Health
                            print("[AutoPets] New target: " .. selectedMobType .. " (" .. math.floor(nextMob.dist) .. " studs)")
                            
                            -- Send pets immediately to new target
                            pcall(function()
                                game:GetService("ReplicatedStorage")
                                    :WaitForChild("Remotes")
                                    :WaitForChild("PetSystem")  -- CHANGE TO YOUR PATH
                                    :WaitForChild("SendPet")     -- or EquipBest, Attack, etc.
                                    :FireServer()  -- add args if needed
                            end)
                        end
                    end
                    
                    -- Check if current target died
                    if currentAttackedMob and currentAttackedMob.humanoid then
                        local lastHealth = trackedHealth[currentAttackedMob.obj] or currentAttackedMob.humanoid.Health
                        local nowHealth = currentAttackedMob.humanoid.Health
                        
                        if lastHealth > 0 and nowHealth <= 0 then
                            print("[AutoPets] Current target died - sending pets & switching")
                            
                            -- Send pets on death
                            pcall(function()
                                game:GetService("ReplicatedStorage")
                                    :WaitForChild("Remotes")
                                    :WaitForChild("PetSystem")
                                    :WaitForChild("SendPet")
                                    :FireServer()
                            end)
                            
                            -- Immediately find and switch to next mob
                            local nextMob = findClosestMobOfType()
                            if nextMob then
                                currentAttackedMob = nextMob
                                trackedHealth[nextMob.obj] = nextMob.humanoid.Health
                                
                                -- Send pets to the new target right away
                                pcall(function()
                                    game:GetService("ReplicatedStorage")
                                        :WaitForChild("Remotes")
                                        :WaitForChild("PetSystem")
                                        :WaitForChild("SendPet")
                                        :FireServer()
                                end)
                            else
                                currentAttackedMob = nil
                            end
                        end
                        
                        trackedHealth[currentAttackedMob.obj] = nowHealth
                    end
                end
                
                -- Cleanup when disabled
                currentAttackedMob = nil
                trackedHealth = {}
                Rayfield:Notify({
                    Title = "Auto Pets Stopped",
                    Content = "Stopped sending pets on death",
                    Duration = 4
                })
            end)
        else
            currentAttackedMob = nil
            trackedHealth = {}
            Rayfield:Notify({
                Title = "Auto Pets Stopped",
                Content = "Deactivated",
                Duration = 3.5
            })
        end
    end,
})
