-- FULL Rayfield Auto Farm Script – FIXED capitalization
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Nomek Auto Farm",
   LoadingTitle = "Loading...",
   KeySystem = false
})

local Tab = Window:CreateTab("Main", 4483362458)  -- Tab is now properly created

-- ────────────────────────────────────────────────
-- Your enemy farming logic (with Workspace capital W)
-- ────────────────────────────────────────────────

local selectedEnemyName = nil
local nameToIdsMap = {}
local currentTarget = nil

local function getAllEnemyNames()
    local options = {"None"}
    local tempMap = {}
    
    local mobSpawns = Workspace:FindFirstChild("MobSpawns")
    if not mobSpawns then
        warn("[AutoFarm] MobSpawns not found in Workspace!")
        return options, tempMap
    end
    
    local nomekFolder = mobSpawns:FindFirstChild("Nomek")
    if not nomekFolder then
        warn("[AutoFarm] Nomek folder not found inside MobSpawns!")
        return options, tempMap
    end
    
    print("[Debug] Nomek folder found – scanning children...")
    
    for _, part in ipairs(nomekFolder:GetChildren()) do
        if part:IsA("BasePart") and #part.Name == 32 and part.Name:match("^%x+$") then
            local nameAttr = part:GetAttribute("Name")
            if nameAttr and type(nameAttr) == "string" and #nameAttr >= 3 then
                local displayName = nameAttr
                if not tempMap[displayName] then
                    tempMap[displayName] = {}
                    table.insert(options, displayName)
                end
                table.insert(tempMap[displayName], part.Name)
                print("[Found enemy type] " .. displayName .. "  (ID: " .. part.Name .. ")")
            end
        end
    end
    
    table.sort(options)
    print("[AutoFarm] Loaded " .. (#options - 1) .. " enemy types into dropdown")
    return options, tempMap
end

local function isEnemyAlive(part)
    if not part or not part.Parent then return false end
    local dead = part:GetAttribute("Dead")
    if dead == true then return false end
    return true
end

-- Initial load
local options, initialMap = getAllEnemyNames()
nameToIdsMap = initialMap

local EnemyDropdown = Tab:CreateDropdown({
    Name = "Select Enemy",
    Options = options,
    CurrentOption = {"None"},
    MultipleOptions = false,
    Flag = "EnemyTypeDropdown",
    Callback = function(selectedTable)
        local selected = selectedTable[1] or "None"
        if selected == "None" then
            selectedEnemyName = nil
            currentTarget = nil
            return
        end
        selectedEnemyName = selected
        print("[Selected] Now farming: " .. selected)
    end,
})

Tab:CreateButton({
    Name = "Refresh Enemy Names",
    Callback = function()
        local newOptions, newMap = getAllEnemyNames()
        nameToIdsMap = newMap
        EnemyDropdown:Refresh(newOptions, true)
        EnemyDropdown:Set({"None"})
        Rayfield:Notify({
            Title = "Refreshed",
            Content = (#newOptions - 1) .. " enemy types found!",
            Duration = 3
        })
    end,
})

local function getAliveEnemies()
    if not selectedEnemyName then return {} end
    
    local mobSpawns = Workspace:FindFirstChild("MobSpawns")
    if not mobSpawns then return {} end
    
    local nomekFolder = mobSpawns:FindFirstChild("Nomek")
    if not nomekFolder then return {} end
    
    local player = game.Players.LocalPlayer
    local character = player and player.Character
    local hrp = character and character:FindFirstChild("HumanoidRootPart")
    if not hrp then return {} end
    
    local hexIds = nameToIdsMap[selectedEnemyName] or {}
    local aliveEnemies = {}
    
    for _, hex in ipairs(hexIds) do
        local part = nomekFolder:FindFirstChild(hex)
        if part and part:IsA("BasePart") and isEnemyAlive(part) then
            local dist = (hrp.Position - part.Position).Magnitude
            table.insert(aliveEnemies, {
                part = part,
                hex = hex,
                dist = dist
            })
        end
    end
    
    table.sort(aliveEnemies, function(a, b) return a.dist < b.dist end)
    return aliveEnemies
end

local function teleportToEnemy(hrp, enemyData)
    if not hrp or not enemyData or not enemyData.part then return false end
    if not isEnemyAlive(enemyData.part) then return false end
    
    local targetCFrame = enemyData.part.CFrame * CFrame.new(0, 3, -5)
    hrp.CFrame = targetCFrame
    return true
end

Tab:CreateToggle({
    Name = "Auto Enemies (Teleport)",
    CurrentValue = false,
    Flag = "AutoTeleportAllType",
    Callback = function(Value)
        getgenv().AutoTeleportAllType = Value
        
        if Value then
            task.spawn(function()
                local lastRefreshTime = 0
                
                while getgenv().AutoTeleportAllType do
                    if not selectedEnemyName then
                        task.wait(0.3)
                        continue
                    end
                    
                    local player = game.Players.LocalPlayer
                    local character = player.Character
                    if not character then
                        task.wait(0.3)
                        continue
                    end
                    
                    local hrp = character:FindFirstChild("HumanoidRootPart")
                    if not hrp then
                        task.wait(0.3)
                        continue
                    end
                    
                    local currentTime = tick()
                    if currentTime - lastRefreshTime > 1.5 then
                        local _, newMap = getAllEnemyNames()
                        nameToIdsMap = newMap
                        lastRefreshTime = currentTime
                    end
                    
                    local aliveEnemies = getAliveEnemies()
                    
                    -- Check if current target is still valid
                    if currentTarget and currentTarget.part and currentTarget.part.Parent then
                        local targetStillAlive = false
                        for _, enemy in ipairs(aliveEnemies) do
                            if enemy.hex == currentTarget.hex then
                                targetStillAlive = true
                                currentTarget = enemy
                                break
                            end
                        end
                        if not targetStillAlive then
                            currentTarget = nil
                        end
                    end
                    
                    if not currentTarget and #aliveEnemies > 0 then
                        currentTarget = aliveEnemies[1]
                    end
                    
                    if not currentTarget then
                        task.wait(0.5)
                        continue
                    end
                    
                    if not isEnemyAlive(currentTarget.part) then
                        currentTarget = nil
                        task.wait(0.1)
                        continue
                    end
                    
                    currentTarget.dist = (hrp.Position - currentTarget.part.Position).Magnitude
                    
                    if currentTarget.dist < 6 then
                        task.wait(0.3)
                    else
                        teleportToEnemy(hrp, currentTarget)
                        task.wait(0.2)
                    end
                end
                
                currentTarget = nil
            end)
        else
            currentTarget = nil
        end
    end,
})

-- Final load message
print("✅ Nomek Auto Farm loaded! Open UI → Refresh enemies → Select → Toggle ON")
Rayfield:Notify({
    Title = "Ready",
    Content = "Click 'Refresh Enemy Names' first!\nCheck console for debug info.",
    Duration = 5
})
