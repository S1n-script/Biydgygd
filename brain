-- Load Rayfield (working link as of 2026)
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create the main window
local Window = Rayfield:CreateWindow({
    Name = "HM Hub",
    LoadingTitle = "LOADING HM HUB...",
    LoadingSubtitle = "By Tha Hollows",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "HMhub",
        FileName = "Config"
    },
    KeySystem = false,
})

-- Main tab
local MainTab = Window:CreateTab("Main", 4483362458)

-- Variables
local autoClick = false
local autoStat = false
local selectedStat = "Energy"  -- Default

-- Auto Clicker Toggle
local ClickToggle = MainTab:CreateToggle({
    Name = "Auto Clicker",
    CurrentValue = false,
    Flag = "AutoClickToggle",
    
    Callback = function(Value)
        autoClick = Value
        
        if Value then
            Rayfield:Notify({
                Title = "Auto Clicker",
                Content = "Clicking every ~0.03s...",
                Duration = 3
            })
            
            task.spawn(function()
                while autoClick do
                    pcall(function()
                        local clickRemote = game:GetService("ReplicatedStorage")
                            :WaitForChild("Packages")
                            :WaitForChild("_Index")
                            :WaitForChild("sleitnick_knit@1.5.1")
                            :WaitForChild("knit")
                            :WaitForChild("Services")
                            :WaitForChild("ClickService")
                            :WaitForChild("RF")
                            :WaitForChild("Click")
                        
                        clickRemote:InvokeServer()
                    end)
                    
                    task.wait(0.1)
                end
            end)
        end
    end,
})

-- Misc Tab
local MiscTab = Window:CreateTab("Misc", 4483362458)

-- Auto Rank Up Toggle (on MiscTab)
local AutoRankUpToggle = MiscTab:CreateToggle({
    Name = "Auto Rank Up",
    CurrentValue = false,
    Flag = "AutoRankUp",
    
    Callback = function(Value)
        getgenv().AutoRankUp = Value
        
        if Value then
            Rayfield:Notify({
                Title = "Auto Rank Up",
                Content = "Ranking up every 60s...",
                Duration = 4
            })
            
            task.spawn(function()
                while getgenv().AutoRankUp do
                    local success, err = pcall(function()
                        game:GetService("ReplicatedStorage")
                            :WaitForChild("Packages")
                            :WaitForChild("_Index")
                            :WaitForChild("sleitnick_knit@1.5.1")
                            :WaitForChild("knit")
                            :WaitForChild("Services")
                            :WaitForChild("RankupService")
                            :WaitForChild("RF")
                            :WaitForChild("RankUp")
                            :InvokeServer()
                    end)
                    
                    if not success then
                        warn("Auto Rank Up error: " .. tostring(err))
                        Rayfield:Notify({
                            Title = "Auto Rank Up Error",
                            Content = "Failed to rank up â€“ check console. Stopping...",
                            Duration = 6
                        })
                        getgenv().AutoRankUp = false
                        break
                    end
                    
                    task.wait(60)
                end
            end)
        else
            Rayfield:Notify({
                Title = "Auto Rank Up",
                Content = "Stopped.",
                Duration = 3
            })
        end
    end,
})

local Tab = Window:CreateTab("Auto Farm", 4483362458) -- Title, Image

-- =====================================
-- Machines Dropdown with AUTO-TELEPORT on Selection
-- =====================================

local machinesFolder = workspace:WaitForChild("Machines")
local player = game.Players.LocalPlayer

local function getMachineNames()
    local names = {}
    local seen = {}

    for _, child in ipairs(machinesFolder:GetChildren()) do
        local name = child.Name
        if name and not seen[name] then
            seen[name] = true
            table.insert(names, name)
        end
    end

    table.sort(names)
    
    if #names == 0 then
        table.insert(names, "No machines found")
    end
    
    return names
end

-- Assuming this is inside your Rayfield UI script (LocalScript)

local player = game.Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage") -- if needed later
local workspace = game.Workspace

-- Shared variables
local selectedMobNames = {}           -- what user selected in dropdown
local currentTarget = nil             -- current closest valid target

-- UI references (adjust Tab/FarmTab to your actual tab name)
-- If you have separate tabs, you can keep two dropdowns â€” but here we merge into one
local MainTab = Tab          -- â† change to your farming tab name
-- local FarmTab = Tab       -- if still using separate tab

-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
--  Core Functions
-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

local function getMobSpawnFolder()
    local mobSpawns = workspace:FindFirstChild("MobSpawns")
    if not mobSpawns then return nil end
    
    -- Try common subfolder patterns
    local candidates = {
        mobSpawns:FindFirstChild("Nomek"),
        -- add more patterns if your game has them, e.g. mobSpawns.CurrentMap, etc.
    }
    
    for _, folder in candidates do
        if folder and #folder:GetChildren() > 0 then
            return folder
        end
    end
    
    -- Fallback: return first folder with parts
    for _, child in mobSpawns:GetChildren() do
        if child:IsA("Folder") and #child:GetChildren() > 0 then
            return child
        end
    end
    
    return nil
end

-- Get all unique enemy/mob types from the active spawn folder
local function getAllMobTypes()
    local options = {"None"}
    local folder = getMobSpawnFolder()
    if not folder then return options end

    local seen = {}
    for _, obj in folder:GetChildren() do
        if obj:IsA("BasePart") or obj:IsA("Model") then
            -- Prefer Attribute "Name" â†’ fallback to object.Name cleaned
            local mobType = obj:GetAttribute("Name") 
                or obj.Name:gsub("_%d+$", ""):gsub("Clone", ""):match("^%s*(.-)%s*$")
            
            if mobType and #mobType > 0 and not seen[mobType] then
                seen[mobType] = true
                table.insert(options, mobType)
            end
        end
    end

    table.sort(options)
    return options
end

-- Improved alive check (works for many systems)
local function isMobAlive(partOrModel)
    local part = partOrModel:IsA("Model") and partOrModel:FindFirstChildWhichIsA("BasePart", true) or partOrModel
    if not part or not part.Parent then return false end

    -- Common death indicators
    if part:GetAttribute("UUID") == nil then return false end
    if part:GetAttribute("Dead") == true then return false end
    
    local health = part:GetAttribute("Health") or part.Parent:GetAttribute("Health")
    if health and type(health) == "number" and health <= 0 then return false end

    -- Optional: Humanoid check if mob uses one
    local hum = part.Parent:FindFirstChildOfClass("Humanoid") 
             or part:FindFirstChildOfClass("Humanoid")
    if hum and hum.Health <= 0 then return false end

    return true
end

-- Get alive mobs of selected types, sorted by distance
local function getAliveMobs()
    if #selectedMobNames == 0 or (#selectedMobNames == 1 and selectedMobNames[1] == "None") then
        return {}
    end

    local folder = getMobSpawnFolder()
    if not folder then return {} end

    local char = player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return {} end

    local allowed = {}
    for _, name in selectedMobNames do
        if name ~= "None" then allowed[name] = true end
    end

    local candidates = {}
    for _, obj in folder:GetChildren() do
        if obj:IsA("BasePart") or obj:IsA("Model") then
            local mobType = obj:GetAttribute("Name") 
                or obj.Name:gsub("_%d+$", ""):gsub("Clone", ""):match("^%s*(.-)%s*$")
            
            if mobType and allowed[mobType] and isMobAlive(obj) then
                local rootPart = obj:IsA("Model") and obj:FindFirstChild("HumanoidRootPart") or obj
                if rootPart then
                    local dist = (hrp.Position - rootPart.Position).Magnitude
                    table.insert(candidates, {
                        obj     = obj,
                        root    = rootPart,
                        dist    = dist,
                        mobType = mobType
                    })
                end
            end
        end
    end

    table.sort(candidates, function(a,b) return a.dist < b.dist end)
    return candidates
end

-- Teleport helper (adjust offset for your combat style)
local function teleportNearMob(hrp, mobData)
    if not hrp or not mobData or not mobData.root then return false end
    if not isMobAlive(mobData.obj) then return false end

    -- Behind + slightly above
    local offset = CFrame.new(0, 3, -4.5)
    hrp.CFrame = mobData.root.CFrame * offset
    return true
end

-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
--  UI Elements
-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

local MobDropdown = MainTab:CreateDropdown({
    Name = "Select Enemy / Mob Type",
    Options = getAllMobTypes(),
    CurrentOption = {"None"},
    MultipleOptions = true,
    Flag = "MobTypeSelector",
    Callback = function(selected)
        selectedMobNames = selected
        if #selected == 0 or (#selected == 1 and selected[1] == "None") then
            currentTarget = nil
        end
        print("Selected mobs:", table.concat(selected, ", "))
    end,
})

MainTab:CreateButton({
    Name = "ðŸ”„ Refresh / Scan Mobs",
    Callback = function()
        local newOptions = getAllMobTypes()
        MobDropdown:Refresh(newOptions, true)
        if #newOptions > 1 then
            MobDropdown:Set({"None"})   -- reset selection after refresh
            Rayfield:Notify({
                Title = "Mob List Updated",
                Content = "Found " .. (#newOptions - 1) .. " mob types",
                Duration = 4.5
            })
        else
            Rayfield:Notify({
                Title = "No Mobs Found",
                Content = "Check if you're near a spawn area",
                Duration = 5
            })
        end
    end,
})

-- Auto Farm / Teleport Toggle
MainTab:CreateToggle({
    Name = "Auto Farm / Teleport to Selected",
    CurrentValue = false,
    Flag = "AutoFarmToggle",
    Callback = function(enabled)
        getgenv().AutoFarmEnabled = enabled

        if enabled then
            task.spawn(function()
                while getgenv().AutoFarmEnabled do
                    task.wait(0.15)

                    local char = player.Character
                    local hrp = char and char:FindFirstChild("HumanoidRootPart")
                    if not hrp then continue end

                    local alive = getAliveMobs()
                    if #alive == 0 then
                        currentTarget = nil
                        task.wait(0.6)
                        continue
                    end

                    -- Validate / update current target
                    if currentTarget and currentTarget.obj then
                        local stillAlive = false
                        for _, e in alive do
                            if e.obj == currentTarget.obj then
                                currentTarget = e
                                stillAlive = true
                                break
                            end
                        end
                        if not stillAlive then
                            currentTarget = nil
                        end
                    end

                    -- Pick new target if needed
                    if not currentTarget then
                        currentTarget = alive[1]
                        print("New target â†’", currentTarget.mobType, " (" .. math.floor(currentTarget.dist) .. " studs)")
                    end

                    if not isMobAlive(currentTarget.obj) then
                        currentTarget = nil
                        continue
                    end

                    currentTarget.dist = (hrp.Position - currentTarget.root.Position).Magnitude

                    if currentTarget.dist > 7 then
                        teleportNearMob(hrp, currentTarget)
                        task.wait(0.25)
                    else
                        task.wait(0.4) -- already close â†’ small delay
                    end
                end
                currentTarget = nil
            end)
        else
            currentTarget = nil
        end
    end,
})
