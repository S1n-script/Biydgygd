-- Load Rayfield (working link as of 2026)
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create the main window
local Window = Rayfield:CreateWindow({
    Name = "HM Hub",
    LoadingTitle = "LOADING HM HUB...",
    LoadingSubtitle = "By Tha Hollows",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "HMhub",
        FileName = "Config"
    },
    KeySystem = false,
})

-- Main tab
local MainTab = Window:CreateTab("Main", 4483362458)

-- Variables
local autoClick = false
local autoStat = false
local selectedStat = "Energy"  -- Default

-- Auto Clicker Toggle
local ClickToggle = MainTab:CreateToggle({
    Name = "Auto Clicker",
    CurrentValue = false,
    Flag = "AutoClickToggle",
    
    Callback = function(Value)
        autoClick = Value
        
        if Value then
            Rayfield:Notify({
                Title = "Auto Clicker",
                Content = "Clicking every ~0.03s...",
                Duration = 3
            })
            
            task.spawn(function()
                while autoClick do
                    pcall(function()
                        local clickRemote = game:GetService("ReplicatedStorage")
                            :WaitForChild("Packages")
                            :WaitForChild("_Index")
                            :WaitForChild("sleitnick_knit@1.5.1")
                            :WaitForChild("knit")
                            :WaitForChild("Services")
                            :WaitForChild("ClickService")
                            :WaitForChild("RF")
                            :WaitForChild("Click")
                        
                        clickRemote:InvokeServer()
                    end)
                    
                    task.wait(0.1)
                end
            end)
        end
    end,
})

-- Misc Tab
local MiscTab = Window:CreateTab("Misc", 4483362458)

-- Auto Rank Up Toggle (on MiscTab)
local AutoRankUpToggle = MiscTab:CreateToggle({
    Name = "Auto Rank Up",
    CurrentValue = false,
    Flag = "AutoRankUp",
    
    Callback = function(Value)
        getgenv().AutoRankUp = Value
        
        if Value then
            Rayfield:Notify({
                Title = "Auto Rank Up",
                Content = "Ranking up every 60s...",
                Duration = 4
            })
            
            task.spawn(function()
                while getgenv().AutoRankUp do
                    local success, err = pcall(function()
                        game:GetService("ReplicatedStorage")
                            :WaitForChild("Packages")
                            :WaitForChild("_Index")
                            :WaitForChild("sleitnick_knit@1.5.1")
                            :WaitForChild("knit")
                            :WaitForChild("Services")
                            :WaitForChild("RankupService")
                            :WaitForChild("RF")
                            :WaitForChild("RankUp")
                            :InvokeServer()
                    end)
                    
                    if not success then
                        warn("Auto Rank Up error: " .. tostring(err))
                        Rayfield:Notify({
                            Title = "Auto Rank Up Error",
                            Content = "Failed to rank up â€“ check console. Stopping...",
                            Duration = 6
                        })
                        getgenv().AutoRankUp = false
                        break
                    end
                    
                    task.wait(60)
                end
            end)
        else
            Rayfield:Notify({
                Title = "Auto Rank Up",
                Content = "Stopped.",
                Duration = 3
            })
        end
    end,
})

-- =====================================
-- Machines Dropdown with AUTO-TELEPORT on Selection
-- =====================================

local machinesFolder = workspace:WaitForChild("Machines")
local player = game.Players.LocalPlayer

local function getMachineNames()
    local names = {}
    local seen = {}

    for _, child in ipairs(machinesFolder:GetChildren()) do
        local name = child.Name
        if name and not seen[name] then
            seen[name] = true
            table.insert(names, name)
        end
    end

    table.sort(names)
    
    if #names == 0 then
        table.insert(names, "No machines found")
    end
    
    return names
end

-- Dropdown - Teleports instantly on selection
local MachinesDropdown = MiscTab:CreateDropdown({
    Name = "Select Machine (Auto-TP)",
    Options = getMachineNames(),
    CurrentOption = {"None"},
    MultipleOptions = false,
    Flag = "MachineTPDropdown",
    
    Callback = function(Option)
        local selectedMachine = Option and Option[1]  -- Extract string
        
        if not selectedMachine or selectedMachine == "No machines found" or selectedMachine == "None" then
            return  -- Do nothing if invalid
        end
        
        -- Notify selection
        Rayfield:Notify({
            Title = "Teleporting...",
            Content = "Moving to: " .. selectedMachine,
            Duration = 3
        })
        print("Auto-TP to machine:", selectedMachine)
        
        -- Find the machine
        local machine = machinesFolder:FindFirstChild(selectedMachine)
        if not machine then
            Rayfield:Notify({
                Title = "Error",
                Content = selectedMachine .. " not found",
                Duration = 4
            })
            return
        end
        
        -- Get HRP from workspace.Players
        local playerFolder = workspace:FindFirstChild("Players")
        if not playerFolder then
            Rayfield:Notify({Title = "Error", Content = "Players folder not found", Duration = 4})
            return
        end
        
        local playerChar = playerFolder:FindFirstChild(player.Name)
        if not playerChar then
            Rayfield:Notify({Title = "Error", Content = "Your character not found", Duration = 4})
            return
        end
        
        local hrp = playerChar:FindFirstChild("HumanoidRootPart")
        if not hrp then
            Rayfield:Notify({Title = "Error", Content = "No HumanoidRootPart found", Duration = 4})
            return
        end
        
        -- Get target CFrame (handles Parts/Models)
        local targetCFrame
        if machine.PrimaryPart then
            targetCFrame = machine.PrimaryPart.CFrame
        elseif machine:IsA("BasePart") then
            targetCFrame = machine.CFrame
        else
            local firstPart = machine:FindFirstChildWhichIsA("BasePart", true)
            targetCFrame = firstPart and firstPart.CFrame or CFrame.new(machine.Position or Vector3.new())
        end
        
        -- Teleport 5 studs above
        local success, err = pcall(function()
            hrp.CFrame = targetCFrame + Vector3.new(0, 5, 0)
        end)
        
        if success then
            print("Auto-teleported to:", selectedMachine)
        else
            warn("TP failed:", tostring(err))
            Rayfield:Notify({
                Title = "Teleport Failed",
                Content = "Check console for error",
                Duration = 4
            })
        end
    end,
})

-- Optional: Refresh button (still useful)
MiscTab:CreateButton({
    Name = "Refresh Machines List",
    Callback = function()
        local newOptions = getMachineNames()
        MachinesDropdown:Refresh(newOptions, true)
        MachinesDropdown:Set({"None"})
        Rayfield:Notify({
            Title = "Refreshed",
            Content = #newOptions .. " machines found",
            Duration = 3
        })
    end,
})


-- =====================================
-- AUTO FARM - Detects current map from workspace.Maps + Mobs from MobSpawns
-- Dropdown shows only mobs on your current island
-- =====================================

local FarmTab = Window:CreateTab("Auto Farm", 4483362458)

local player = game.Players.LocalPlayer
local mapsFolder = workspace:WaitForChild("Maps")
local mobSpawnsFolder = workspace:WaitForChild("MobSpawns")

local autoFarmEnabled = false
local farmDelay = 5
local selectedMobType = nil
local currentMapFolder = nil
local currentMobFolder = nil

-- Detect current map by finding which map folder has corresponding mobs nearby
local function detectCurrentMap()
    local character = player.Character
    if not character then return nil end
    
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    s
local playerPos = root.Position
    local closestMapName = nil
    local minAvgDist = math.huge
    
    for _, mapFolder in ipairs(mapsFolder:GetChildren()) do
        if mapFolder:IsA("Folder") or mapFolder:IsA("Model") then
            local mapName = mapFolder.Name
            local mobFolder = mobSpawnsFolder:FindFirstChild(mapName)
            
            if mobFolder and #mobFolder:GetChildren() > 0 then
                local totalDist = 0
                local count = 0
                
                for _, mob in ipairs(mobFolder:GetChildren()) do
                    if mob:IsA("BasePart") then
                        totalDist += (playerPos - mob.Position).Magnitude
                        count += 1
                    end
                end
                
                if count > 0 then
                    local avgDist = totalDist / count
                    if avgDist < minAvgDist then
                        minAvgDist = avgDist
                        closestMapName = mapName
                        currentMapFolder = mapFolder
                        currentMobFolder = mobFolder
                    end
                end
            end
        end
    end
    
    return closestMapName
end

-- Get unique mob base names from current map's mob folder
local function getMobTypes()
    if not currentMobFolder then return {"Scan map first"} end
    
    local types = {}
    local seen = {}
    
    for _, child in ipairs(currentMobFolder:GetChildren()) do
        if child:IsA("BasePart") then
            local baseName = child.Name:gsub("_%d+$", ""):gsub("Clone", ""):match("^%s*(.-)%s*$")
            if baseName and baseName ~= "" and not seen[baseName] then
                seen[baseName] = true
                table.insert(types, baseName)
            end
        end
    end
    
    table.sort(types)
    return #types > 0 and types or {"No mobs on this map"}
end

-- Dropdown for mobs (will be refreshed on scan)
local MobDropdown = FarmTab:CreateDropdown({
    Name = "Mobs on Current Map",
    Options = {"Scan map first"},
    CurrentOption = {"Scan map first"},
    MultipleOptions = true,
    Flag = "CurrentMapMobs",
    
    Callback = function(Option)
        selectedMobType = Option[1]
        if selectedMobType and selectedMobType ~= "Scan map first" and selectedMobType ~= "No mobs on this map" then
            print("Selected to farm:", selectedMobType, "on", currentMapFolder and currentMapFolder.Name or "unknown")
        end
    end,
})

-- Scan & refresh button
FarmTab:CreateButton({
    Name = "ðŸ” Scan Current Map & Load Mobs",
    Callback = function()
        currentMapFolder = nil
        currentMobFolder = nil
        local mapName = detectCurrentMap()
        
        if mapName then
            local mobCount = currentMobFolder and #currentMobFolder:GetChildren() or 0
            local typesCount = #getMobTypes()
            
            Rayfield:Notify({
                Title = "Map Detected",
                Content = mapName .. " (" .. mobCount .. " mobs, " .. typesCount .. " types)",
                Duration = 5
            })
            
            MobDropdown:Refresh(getMobTypes(), true)
        else
            Rayfield:Notify({
                Title = "No Map Detected",
                Content = "Move closer to mobs on a map",
                Duration = 6
            })
            MobDropdown:Refresh({"Scan map first"}, true)
        end
    end,
})    


local selectedEnemyNames = {}
local currentTarget = nil

-- Get unique enemy type names from the "Name" attribute
local function getAllEnemyNames()
    local options = {"None"}
    local folder = workspace:FindFirstChild("MobSpawns") and workspace.MobSpawns:FindFirstChild("Nomek")
    if not folder then return options end

    local seen = {}
    for _, obj in ipairs(folder:GetChildren()) do
        if obj:IsA("BasePart") then
            local enemyType = obj:GetAttribute("Name")
            if enemyType and type(enemyType) == "string" and #enemyType > 0 then
                if not seen[enemyType] then
                    seen[enemyType] = true
                    table.insert(options, enemyType)
                end
            end
        end
    end

    table.sort(options)
    return options
end

-- Alive check: requires UUID to exist, and Health > 0 if present
local function isEnemyAlive(part)
    if not part or not part.Parent then
        print("Enemy dead: part removed")
        return false
    end

    -- UUID must exist (if missing, mob is dead/despawned)
    if not part:GetAttribute("UUID") then
        print("Enemy dead: UUID missing")
        return false
    end

    -- Check for a "Dead" attribute
    if part:GetAttribute("Dead") == true then
        print("Enemy dead: Dead attribute true")
        return false
    end

    -- Check Health attribute
    local health = part:GetAttribute("Health")
    if health and type(health) == "number" then
        if health <= 0 then
            print("Enemy dead: Health <= 0")
            return false
        end
    end

    -- If it passed all checks, consider alive
    return true
end

-- Dropdown
local EnemyDropdown = Tab:CreateDropdown({
    Name = "Select Enemy",
    Options = getAllEnemyNames(),
    CurrentOption = {"None"},
    MultipleOptions = true,
    Flag = "EnemyTypeDropdown",
    Callback = function(selectedTable)
        selectedEnemyNames = selectedTable
        if #selectedEnemyNames == 0 or (selectedEnemyNames[1] == "None" and #selectedEnemyNames == 1) then
            currentTarget = nil
        end
    end,
})

-- Refresh button
Tab:CreateButton({
    Name = "Refresh Enemy Names",
    Callback = function()
        local newOptions = getAllEnemyNames()
        EnemyDropdown:Refresh(newOptions)
        EnemyDropdown:Set({"None"})
    end,
})

-- Returns alive enemies from selected types, sorted by distance
local function getAliveEnemies()
    if #selectedEnemyNames == 0 or (selectedEnemyNames[1] == "None" and #selectedEnemyNames == 1) then
        return {}
    end

    local folder = workspace:FindFirstChild("MobSpawns") and workspace.MobSpawns:FindFirstChild("Nomek")
    if not folder then return {} end

    local player = game.Players.LocalPlayer
    local character = player and player.Character
    local hrp = character and character:FindFirstChild("HumanoidRootPart")
    if not hrp then return {} end

    local selectedSet = {}
    for _, name in ipairs(selectedEnemyNames) do
        if name ~= "None" then
            selectedSet[name] = true
        end
    end

    local allAlive = {}
    for _, obj in ipairs(folder:GetChildren()) do
        if obj:IsA("BasePart") then
            local enemyType = obj:GetAttribute("Name")
            if enemyType and selectedSet[enemyType] and isEnemyAlive(obj) then
                local dist = (hrp.Position - obj.Position).Magnitude
                table.insert(allAlive, {
                    part = obj,
                    dist = dist,
                    enemyType = enemyType
                })
            end
        end
    end

    table.sort(allAlive, function(a, b) return a.dist < b.dist end)
    return allAlive
end

local function teleportToEnemy(hrp, enemyData)
    if not hrp or not enemyData or not enemyData.part then return false end
    if not isEnemyAlive(enemyData.part) then return false end

    -- Adjust offset as needed (behind and above)
    local targetCFrame = enemyData.part.CFrame * CFrame.new(0, 3, -5)
    hrp.CFrame = targetCFrame
    return true
end

-- Auto toggle
local AutoEnemiesToggle = Tab:CreateToggle({
    Name = "Auto Enemies",
    CurrentValue = false,
    Flag = "AutoTeleportAllType",
    Callback = function(Value)
        getgenv().AutoTeleportAllType = Value

        if Value then
            task.spawn(function()
                while getgenv().AutoTeleportAllType do
                    if #selectedEnemyNames == 0 or (selectedEnemyNames[1] == "None" and #selectedEnemyNames == 1) then
                        task.wait(0.3)
                        continue
                    end

                    local player = game.Players.LocalPlayer
                    local character = player.Character
                    if not character then
                        task.wait(0.3)
                        continue
                    end

                    local hrp = character:FindFirstChild("HumanoidRootPart")
                    if not hrp then
                        task.wait(0.3)
                        continue
                    end

                    local aliveEnemies = getAliveEnemies()

                    -- Check if current target is still alive
                    if currentTarget and currentTarget.part then
                        local stillAlive = false
                        for _, enemy in ipairs(aliveEnemies) do
                            if enemy.part == currentTarget.part then
                                stillAlive = true
                                currentTarget = enemy  -- update distance
                                break
                            end
                        end
                        if not stillAlive then
                            print("Current target dead, clearing")
                            currentTarget = nil
                        end
                    end

                    if not currentTarget and #aliveEnemies > 0 then
                        currentTarget = aliveEnemies[1]
                        print("New target:", currentTarget.enemyType, "at distance", currentTarget.dist)
                    end

                    if not currentTarget then
                        task.wait(0.5)
                        continue
                    end

                    if not isEnemyAlive(currentTarget.part) then
                        print("Target died, clearing")
                        currentTarget = nil
                        task.wait(0.1)
                        continue
                    end

                    currentTarget.dist = (hrp.Position - currentTarget.part.Position).Magnitude

                    if currentTarget.dist < 6 then
                        task.wait(0.3)
                    else
                        teleportToEnemy(hrp, currentTarget)
                        task.wait(0.2)
                    end
                end
                currentTarget = nil
            end)
        else
            currentTarget = nil
        end
    end,
})
